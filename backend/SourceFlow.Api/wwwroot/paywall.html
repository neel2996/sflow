<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SourceFlow - Get Credits</title>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 40px 20px; color: #333; max-width: 420px; margin: 40px auto; }
    h2 { color: #0073b1; font-size: 24px; margin-bottom: 8px; }
    .subtitle { color: #666; font-size: 14px; margin-bottom: 24px; }
    .not-auth { color: #666; margin-top: 20px; }
    .loading { text-align: center; color: #666; }
    .error { color: #b24020; font-size: 13px; margin-bottom: 12px; }
    .plans { display: flex; flex-direction: column; gap: 12px; }
    .plan-card { padding: 16px; border: 1px solid #e0e0e0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
    .plan-name { font-weight: 600; font-size: 16px; }
    .plan-credits { font-size: 13px; color: #666; margin-top: 4px; }
    .buy-btn { padding: 10px 20px; background: #0073b1; color: #fff; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; }
    .buy-btn:disabled { opacity: 0.6; cursor: wait; }
    .mock-btn { background: #057642 !important; font-size: 12px !important; padding: 8px 12px !important; }
    .footer { font-size: 12px; color: #666; margin-top: 24px; }
  </style>
</head>
<body>
  <h2>Get Credits</h2>
  <p class="subtitle" id="subtitle">Loading...</p>
  <div id="not-auth" class="not-auth" style="display:none">Please log in via the extension first, then open this page again.</div>
  <div id="loading" class="loading">Loading plans...</div>
  <p id="error" class="error" style="display:none"></p>
  <div id="plans" class="plans" style="display:none"></div>
  <div id="success-section" style="display:none; margin-top:20px; padding:16px; border:1px solid #057642; border-radius:8px; background:#f0f9f0;">
    <p style="margin:0; font-weight:600; color:#057642; font-size:16px;" id="success-msg">Credits purchased!</p>
    <p style="margin:8px 0 0; font-size:13px; color:#666;">You can close this tab and return to the extension.</p>
  </div>
  <div id="verify-section" style="display:none; margin-top:20px; padding:16px; border:1px solid #057642; border-radius:8px; background:#f0f9f0;">
    <p style="margin:0 0 12px; font-weight:600; color:#057642;">Razorpay payment completed?</p>
    <p style="margin:0 0 12px; font-size:13px; color:#666;">Webhooks can't reach localhost. Click Verify to simulate the webhook and add credits.</p>
    <button id="verify-btn" class="buy-btn" style="background:#057642;">Verify webhook (simulate)</button>
  </div>
  <p class="footer">1 credit = 1 LinkedIn profile scan</p>

  <script>
    const params = new URLSearchParams(location.search);
    const token = params.get("token");
    const urlCountry = params.get("country") || "IN";
    let country = urlCountry;
    let isIndia = country.toUpperCase() === "IN";
    let lastPurchased = null; // { planId } for localhost simulate
    const isLocalhost = location.hostname === "localhost" || location.hostname === "127.0.0.1";

    const API_BASE = location.origin;

    async function api(method, path, body) {
      const opts = { method, headers: { "Content-Type": "application/json" } };
      if (token) opts.headers["Authorization"] = "Bearer " + token;
      if (body) opts.body = JSON.stringify(body);
      const res = await fetch(API_BASE + path, opts);
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.error || res.statusText);
      return data;
    }

    async function init() {
      document.getElementById("loading").style.display = "block";
      document.getElementById("plans").style.display = "none";
      document.getElementById("error").style.display = "none";
      document.getElementById("not-auth").style.display = "none";

      if (!token) {
        document.getElementById("loading").style.display = "none";
        document.getElementById("not-auth").style.display = "block";
        return;
      }

      try {
        // Use backend as source of truth for country (from Users table)
        const me = await api("GET", "/user/me");
        if (me && me.country) {
          country = String(me.country).trim();
          isIndia = country.toUpperCase() === "IN" || country.toUpperCase() === "INDIA";
        }

        let [plans, config] = await Promise.all([
          api("GET", "/payments/plans?country=" + encodeURIComponent(country)),
          api("GET", "/payments/client-config")
        ]);

        // Ensure Custom Credits is always last: Starter, Growth, Pro, then Custom
        if (plans && plans.length > 1) {
          const isCustomPlan = (p) => (p.plan_type || p.planType || "").toLowerCase() === "custom" || p.is_custom === true || p.isCustom === true || (p.name || "").toLowerCase().includes("custom");
          const customPlans = plans.filter(isCustomPlan);
          const otherPlans = plans.filter(p => !isCustomPlan(p));
          plans = [...otherPlans.sort((a, b) => (a.price || a.Price || 0) - (b.price || b.Price || 0)), ...customPlans];
        }

        // Set subtitle from actual plans (not assumed) so it always matches
        const planCurrency = plans && plans[0] ? plans[0].currency : (isIndia ? "INR" : "USD");
        document.getElementById("subtitle").textContent = planCurrency === "INR" ? "One-time credit packs (INR)" : "Subscription plans (USD)";

        document.getElementById("loading").style.display = "none";

        const container = document.getElementById("plans");
        const mockEnabled = config.mock_enabled === true;
        container.innerHTML = "";

        if (!plans || plans.length === 0) {
          container.innerHTML = '<p style="color:#666;">No plans available. Ensure the database is seeded.</p>';
          container.style.display = "block";
        } else plans.forEach((p, i) => {
          const div = document.createElement("div");
          div.className = "plan-card";
          const planType = (p.plan_type || p.planType || "").toLowerCase();
          const isUnlimited = planType === "unlimited";
          const isCustom = planType === "custom" || p.is_custom === true || p.isCustom === true || (p.name || "").toLowerCase().includes("custom");
          let desc = "";
          if (isUnlimited) desc = (p.duration_hours || 24) + " hours unlimited";
          else if (isCustom) desc = "1 credit = ₹1 – enter number below";
          else desc = p.credits + " credits" + ((p.billing_type === "subscription" || p.billing_type === "Monthly") ? " / month" : "");

          const customInput = isCustom ? `<input type="number" min="1" max="10000" placeholder="Enter credits" id="custom-credits-${i}" class="custom-credits-input" data-index="${i}" style="width:80px;padding:8px;margin-right:8px;border:1px solid #e0e0e0;border-radius:6px;font-size:14px;" />` : "";
          const buyBtnDisabled = isCustom ? " disabled" : "";
          div.innerHTML = `
            <div>
              <div class="plan-name">${escapeHtml(p.name)}</div>
              <div class="plan-credits">${desc}</div>
              ${isCustom ? "<div style='font-size:12px;color:#666;margin-top:6px'>1 credit = ₹1. Enter number of credits to buy.</div>" : ""}
            </div>
            <div style="display:flex;gap:8px;align-items:center;">
              ${customInput}
              ${mockEnabled && p.provider === "razorpay" ? `<button class="buy-btn mock-btn" data-index="${i}"${buyBtnDisabled}>Test (mock)</button>` : ""}
              <button class="buy-btn buy-btn-main" data-index="${i}"${buyBtnDisabled}>${isIndia ? "Buy" : "Subscribe"}</button>
            </div>
          `;
          container.appendChild(div);
        });
        if (plans && plans.length > 0) container.style.display = "flex";

        const razorpayKey = config.razorpay_key_id || "";
        container.querySelectorAll(".buy-btn:not(.mock-btn)").forEach(btn => {
          btn.onclick = () => {
            const plan = plans[parseInt(btn.dataset.index)];
            const customInput = document.getElementById("custom-credits-" + btn.dataset.index);
            const planIsCustom = (plan.plan_type || plan.planType || "").toLowerCase() === "custom" || plan.is_custom === true || plan.isCustom === true;
            const credits = planIsCustom && customInput ? parseInt(customInput.value, 10) : null;
            if (planIsCustom) {
              if (!credits || credits < 1 || credits > 10000) {
                document.getElementById("error").textContent = "Enter credits between 1 and 10000";
                document.getElementById("error").style.display = "block";
                return;
              }
            }
            handlePlan(plan, razorpayKey, btn, false, credits);
          };
        });
        container.querySelectorAll(".mock-btn").forEach(btn => {
          btn.onclick = () => {
            const plan = plans[parseInt(btn.dataset.index)];
            const customInput = document.getElementById("custom-credits-" + btn.dataset.index);
            const planIsCustom = (plan.plan_type || plan.planType || "").toLowerCase() === "custom" || plan.is_custom === true || plan.isCustom === true;
            const credits = planIsCustom && customInput ? parseInt(customInput.value, 10) : null;
            if (planIsCustom) {
              if (!credits || credits < 1 || credits > 10000) {
                document.getElementById("error").textContent = "Enter credits between 1 and 10000";
                document.getElementById("error").style.display = "block";
                return;
              }
            }
            handlePlan(plan, razorpayKey, btn, true, credits);
          };
        });

        // Enable Buy button for custom plan only when valid credits (1–10000) entered
        container.querySelectorAll(".custom-credits-input").forEach(input => {
          const updateButtons = () => {
            const val = parseInt(input.value, 10);
            const valid = !isNaN(val) && val >= 1 && val <= 10000;
            const idx = input.dataset.index;
            container.querySelectorAll(`.buy-btn[data-index="${idx}"]`).forEach(b => { b.disabled = !valid; });
          };
          input.addEventListener("input", updateButtons);
          input.addEventListener("change", updateButtons);
        });
      } catch (err) {
        document.getElementById("loading").style.display = "none";
        document.getElementById("error").textContent = err.message;
        document.getElementById("error").style.display = "block";
      }
    }

    async function handlePlan(plan, razorpayKey, btn, useMock, customCredits) {
      btn.disabled = true;
      document.getElementById("error").style.display = "none";

      try {
        if (useMock && plan.provider === "razorpay") {
          const mockBody = { plan_id: plan.id };
          if (customCredits) mockBody.credits = customCredits;
          const res = await api("POST", "/payments/mock-razorpay-success", mockBody);
          alert((res.credits_added > 0 ? "Credits added: " + res.credits_added : "Unlimited access activated") + ". You can close this tab.");
          window.close();
          return;
        }
        const body = { plan_id: plan.id };
        if (customCredits) body.credits = customCredits;
        const res = await api("POST", "/payments/create-order", body);
        if (res.provider === "paddle" && res.checkout_url) {
          window.location.href = res.checkout_url;
          return;
        }
        if (res.order_id || res.orderId) {
          if (!razorpayKey && !res.key) throw new Error("Razorpay not configured");
          const orderId = res.order_id || res.orderId;
          const rzp = new Razorpay({
            key: res.key || razorpayKey,
            order_id: orderId,
            name: "SourceFlow",
            description: (plan.plan_type || plan.planType || "").toLowerCase() === "unlimited" ? plan.name + " - " + (plan.duration_hours || plan.durationHours || 24) + "h unlimited" : ((plan.plan_type || plan.planType || "").toLowerCase() === "custom" || plan.is_custom || plan.isCustom) ? plan.name + " - " + (customCredits || 0) + " credits" : plan.name + " - " + (plan.credits || 0) + " credits",
            handler: async (response) => {
              if (isLocalhost) {
                lastPurchased = { planId: plan.id, paymentId: (typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : 'sim_' + Date.now() + '_' + Math.random().toString(36).slice(2), credits: customCredits || null };
                document.getElementById("verify-section").style.display = "block";
              } else {
                try {
                  const verifyRes = await api("POST", "/payments/verify-razorpay", {
                    order_id: response.razorpay_order_id,
                    payment_id: response.razorpay_payment_id
                  });
                  document.getElementById("plans").style.display = "none";
                  const successMsg = document.getElementById("success-msg");
                  successMsg.textContent = (verifyRes.credits_added > 0 ? "Credits purchased!" : "Unlimited access activated!");
                  document.getElementById("success-section").style.display = "block";
                } catch (err) {
                  document.getElementById("error").textContent = err.message || "Failed to verify payment. Credits may still be added via webhook.";
                  document.getElementById("error").style.display = "block";
                }
              }
            }
          });
          rzp.open();
        }
      } catch (err) {
        document.getElementById("error").textContent = err.message;
        document.getElementById("error").style.display = "block";
      } finally {
        btn.disabled = false;
      }
    }

    function escapeHtml(s) {
      const d = document.createElement("div");
      d.textContent = s || "";
      return d.innerHTML;
    }

    document.getElementById("verify-btn").onclick = async () => {
      if (!lastPurchased) return;
      const btn = document.getElementById("verify-btn");
      btn.disabled = true;
      document.getElementById("error").style.display = "none";
      try {
        const body = { plan_id: lastPurchased.planId, payment_id: lastPurchased.paymentId };
        if (lastPurchased.credits) body.credits = lastPurchased.credits;
        const res = await api("POST", "/payments/simulate-razorpay-webhook", body);
        if (res.credits_added > 0) {
          alert("Verified! Credits added: " + res.credits_added + ". New balance: " + res.new_balance);
        } else {
          alert("Already verified. Your balance: " + res.new_balance);
        }
        document.getElementById("verify-section").style.display = "none";
        lastPurchased = null;
      } catch (err) {
        document.getElementById("error").textContent = err.message;
        document.getElementById("error").style.display = "block";
      } finally {
        btn.disabled = false;
      }
    };

    init();
  </script>
</body>
</html>
