<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SourceFlow - Get Credits</title>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 40px 20px; color: #333; max-width: 420px; margin: 40px auto; }
    h2 { color: #0073b1; font-size: 24px; margin-bottom: 8px; }
    .subtitle { color: #666; font-size: 14px; margin-bottom: 24px; }
    .not-auth { color: #666; margin-top: 20px; }
    .loading { text-align: center; color: #666; }
    .error { color: #b24020; font-size: 13px; margin-bottom: 12px; }
    .plans { display: flex; flex-direction: column; gap: 12px; }
    .plan-card { padding: 16px; border: 1px solid #e0e0e0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
    .plan-name { font-weight: 600; font-size: 16px; }
    .plan-credits { font-size: 13px; color: #666; margin-top: 4px; }
    .buy-btn { padding: 10px 20px; background: #0073b1; color: #fff; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; }
    .buy-btn:disabled { opacity: 0.6; cursor: wait; }
    .mock-btn { background: #057642 !important; font-size: 12px !important; padding: 8px 12px !important; }
    .footer { font-size: 12px; color: #666; margin-top: 24px; }
  </style>
</head>
<body>
  <h2>Get Credits</h2>
  <p class="subtitle" id="subtitle">Loading...</p>
  <div id="not-auth" class="not-auth" style="display:none">Please log in via the extension first, then open this page again.</div>
  <div id="loading" class="loading">Loading plans...</div>
  <p id="error" class="error" style="display:none"></p>
  <div id="plans" class="plans" style="display:none"></div>
  <div id="verify-section" style="display:none; margin-top:20px; padding:16px; border:1px solid #057642; border-radius:8px; background:#f0f9f0;">
    <p style="margin:0 0 12px; font-weight:600; color:#057642;">Razorpay payment completed?</p>
    <p style="margin:0 0 12px; font-size:13px; color:#666;">Webhooks can't reach localhost. Click Verify to simulate the webhook and add credits.</p>
    <button id="verify-btn" class="buy-btn" style="background:#057642;">Verify webhook (simulate)</button>
  </div>
  <p class="footer">1 credit = 1 LinkedIn profile scan</p>

  <script>
    const params = new URLSearchParams(location.search);
    const token = params.get("token");
    const urlCountry = params.get("country") || "IN";
    let country = urlCountry;
    let isIndia = country.toUpperCase() === "IN";
    let lastPurchased = null; // { planId, paymentId }

    const API_BASE = location.origin;

    async function api(method, path, body) {
      const opts = { method, headers: { "Content-Type": "application/json" } };
      if (token) opts.headers["Authorization"] = "Bearer " + token;
      if (body) opts.body = JSON.stringify(body);
      const res = await fetch(API_BASE + path, opts);
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.error || res.statusText);
      return data;
    }

    async function init() {
      document.getElementById("loading").style.display = "block";
      document.getElementById("plans").style.display = "none";
      document.getElementById("error").style.display = "none";
      document.getElementById("not-auth").style.display = "none";

      if (!token) {
        document.getElementById("loading").style.display = "none";
        document.getElementById("not-auth").style.display = "block";
        return;
      }

      try {
        // Use backend as source of truth for country (from Users table)
        const me = await api("GET", "/user/me");
        if (me && me.country) {
          country = String(me.country).trim();
          isIndia = country.toUpperCase() === "IN" || country.toUpperCase() === "INDIA";
        }

        const [plans, config] = await Promise.all([
          api("GET", "/payments/plans?country=" + encodeURIComponent(country)),
          api("GET", "/payments/client-config")
        ]);

        // Set subtitle from actual plans (not assumed) so it always matches
        const planCurrency = plans && plans[0] ? plans[0].currency : (isIndia ? "INR" : "USD");
        document.getElementById("subtitle").textContent = planCurrency === "INR" ? "One-time credit packs (INR)" : "Subscription plans (USD)";

        document.getElementById("loading").style.display = "none";

        const container = document.getElementById("plans");
        const mockEnabled = config.mock_enabled === true;
        container.innerHTML = "";

        if (!plans || plans.length === 0) {
          container.innerHTML = '<p style="color:#666;">No plans available. Ensure the database is seeded.</p>';
          container.style.display = "block";
        } else plans.forEach((p, i) => {
          const div = document.createElement("div");
          div.className = "plan-card";
          div.innerHTML = `
            <div>
              <div class="plan-name">${escapeHtml(p.name)}</div>
              <div class="plan-credits">${p.credits} credits${(p.billing_type === "subscription" || p.billing_type === "Monthly") ? " / month" : ""}</div>
            </div>
            <div style="display:flex;gap:8px;">
              ${mockEnabled && p.provider === "razorpay" ? `<button class="buy-btn mock-btn" data-index="${i}">Test (mock)</button>` : ""}
              <button class="buy-btn" data-index="${i}">${isIndia ? "Buy" : "Subscribe"}</button>
            </div>
          `;
          container.appendChild(div);
        });
        if (plans && plans.length > 0) container.style.display = "flex";

        const razorpayKey = config.razorpay_key_id || "";
        container.querySelectorAll(".buy-btn:not(.mock-btn)").forEach(btn => {
          btn.onclick = () => handlePlan(plans[parseInt(btn.dataset.index)], razorpayKey, btn, false);
        });
        container.querySelectorAll(".mock-btn").forEach(btn => {
          btn.onclick = () => handlePlan(plans[parseInt(btn.dataset.index)], razorpayKey, btn, true);
        });
      } catch (err) {
        document.getElementById("loading").style.display = "none";
        document.getElementById("error").textContent = err.message;
        document.getElementById("error").style.display = "block";
      }
    }

    async function handlePlan(plan, razorpayKey, btn, useMock) {
      btn.disabled = true;
      document.getElementById("error").style.display = "none";

      try {
        if (useMock && plan.provider === "razorpay") {
          const res = await api("POST", "/payments/mock-razorpay-success", { plan_id: plan.id });
          alert("Credits added: " + res.credits_added + ". You can close this tab.");
          window.close();
          return;
        }
        const res = await api("POST", "/payments/create-order", { plan_id: plan.id });
        if (res.provider === "paddle" && res.checkout_url) {
          window.location.href = res.checkout_url;
          return;
        }
        if (res.order_id || res.orderId) {
          if (!razorpayKey && !res.key) throw new Error("Razorpay not configured");
          const rzp = new Razorpay({
            key: res.key || razorpayKey,
            order_id: res.order_id || res.orderId,
            name: "SourceFlow",
            description: plan.name + " - " + plan.credits + " credits",
            handler: () => {
              lastPurchased = { planId: plan.id, paymentId: (typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : 'sim_' + Date.now() + '_' + Math.random().toString(36).slice(2) };
              document.getElementById("verify-section").style.display = "block";
            }
          });
          rzp.open();
        }
      } catch (err) {
        document.getElementById("error").textContent = err.message;
        document.getElementById("error").style.display = "block";
      } finally {
        btn.disabled = false;
      }
    }

    function escapeHtml(s) {
      const d = document.createElement("div");
      d.textContent = s || "";
      return d.innerHTML;
    }

    document.getElementById("verify-btn").onclick = async () => {
      if (!lastPurchased) return;
      const btn = document.getElementById("verify-btn");
      btn.disabled = true;
      document.getElementById("error").style.display = "none";
      try {
        const res = await api("POST", "/payments/simulate-razorpay-webhook", { plan_id: lastPurchased.planId, payment_id: lastPurchased.paymentId });
        if (res.credits_added > 0) {
          alert("Verified! Credits added: " + res.credits_added + ". New balance: " + res.new_balance);
        } else {
          alert("Already verified. Your balance: " + res.new_balance);
        }
        document.getElementById("verify-section").style.display = "none";
        lastPurchased = null;
      } catch (err) {
        document.getElementById("error").textContent = err.message;
        document.getElementById("error").style.display = "block";
      } finally {
        btn.disabled = false;
      }
    };

    init();
  </script>
</body>
</html>
